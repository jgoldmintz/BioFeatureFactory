# NetSurfP-3.0 Pipeline

High-throughput protein structure prediction for WT and mutant sequences using NetSurfP-3.0. Predicts surface accessibility, secondary structure, disorder regions, and binding sites.

---

## 1. Overview

NetSurfP-3.0 predicts multiple structural features per residue:
- **Surface Accessibility** (RSA/ASA): Solvent exposure
- **Secondary Structure** (SS3/SS8): Helix, strand, coil assignments
- **Disorder**: Intrinsically disordered regions
- **Binding Sites**: Protein-protein and protein-nucleic acid binding

This pipeline:
- Compares WT vs mutant structural changes at the mutation site and globally
- Identifies buried-to-exposed transitions, disorder changes, and secondary structure shifts
- Generates ensemble TSV outputs with delta scores and classifications
- Supports batch processing for large datasets

---

## 2. Requirements

| Component | Notes |
|-----------|-------|
| **NetSurfP-3.0 library** | Clone from https://github.com/Eryk96/NetSurfP-3.0 into `NSP3/nsp3/` |
| Python ≥3.9 | Uses shared utilities from `../utils/`. |
| Mapping CSVs | Per-gene NT->AA mappings (`mutant`, `aamutant`). Generated by exon-aware pipeline. |
| WT FASTAs | ORF FASTAs (header `>ORF`) in a directory or single file. |
| Log files (optional) | Validation logs to filter known failures. |

### NetSurfP-3.0 Library Setup

```bash
cd NetSurfP3/
git clone https://github.com/Eryk96/NetSurfP-3.0.git nsp3
```

The pipeline imports directly from the `nsp3/` subdirectory.

---

## 3. Installation

### Native Installation (Linux/macOS with PyTorch)

1. Clone NetSurfP-3.0 from the official repository
2. Install dependencies (PyTorch, ESM model weights)
3. Ensure `predict.py` is accessible via `--native-netsurfp-path`

```bash
# Example installation
git clone https://github.com/... netsurfp-3.0
cd netsurfp-3.0
pip install -r requirements.txt
# Download ESM model weights as per NetSurfP documentation
```

---

## 4. Running

### Full pipeline (WT FASTA -> Mutant synthesis -> NetSurfP -> TSV ensemble)

```bash
python netsurfp3-pipeline.py \
    ../../FASTA_files/newnt3/ \
    results/netsurfp_summary.tsv \
    --mode full-pipeline \
    --mapping-dir ../../mutations/combined/aa \
    --log /path/to/validation.log \
    --rsa-threshold 0.1 \
    --disorder-threshold 0.1 \
    --keep-intermediates
```

This flow:
1. Loads ORF nucleotide FASTAs and translates to amino acids
2. Synthesizes mutant AA sequences from mapping CSVs
3. Runs NetSurfP-3.0 on both WT and mutant sequences
4. Generates ensemble TSV with structural change analysis

### NetSurfP-only processing (no parsing)

```bash
python netsurfp3-pipeline.py \
    wt/ABCB1.fasta \
    raw_outputs/ \
    --mode netsurfp-only
```

Produces raw NetSurfP output files without parsing.

### Parse-only mode

```bash
python netsurfp3-pipeline.py \
    netsurfp_outputs/ \
    parsed_results.tsv \
    --mode parse-only \
    --mapping-dir ../../mutations/combined/aa
```

Parses existing NetSurfP outputs into ensemble TSV format.

---

## 5. Output Files

### 5.1 Summary TSV (`*.tsv`)

Per-mutation summary with structural changes:

| Column | Description | Units |
|--------|-------------|-------|
| `pkey` | `{GENE}-{MUTATION}` primary key | string |
| `mutation_pos` | Position of the mutation | residue index |
| `wt_aa`, `mut_aa` | WT and mutant amino acids | single-letter |
| `delta_rsa`, `delta_asa` | Change in relative/absolute surface accessibility | 0-1 / Ų |
| `delta_disorder` | Change in disorder probability | 0-1 |
| `delta_binding` | Change in binding site probability | 0-1 |
| `ss3_change`, `ss8_change` | Secondary structure transitions | categorical |
| `burial_classification` | Buried/Intermediate/Exposed change | categorical |
| `disorder_classification` | Ordered/Disordered change | categorical |
| `local_structural_impact` | Sum of \|Δ\| within ±5 residues | various |
| `global_mean_delta_rsa` | Average RSA change across all residues | 0-1 |
| `global_ss_changes` | Count of secondary structure changes | count |
| `qc_flags` | Quality control flags | string |

### 5.2 Per-Residue TSV (`*.sites.tsv`)

Raw predictions for all residues:

| Column | Description | Units |
|--------|-------------|-------|
| `pos` | Residue position | residue index |
| `aa` | Amino acid | single-letter |
| `rsa` | Relative Solvent Accessibility | 0-1 (0=buried, 1=exposed) |
| `asa` | Absolute Solvent Accessibility | Ų |
| `ss3` | 3-state secondary structure | H/E/C (helix/strand/coil) |
| `ss8` | 8-state secondary structure | G/H/I/B/E/S/T/C |
| `disorder` | Disorder probability | 0-1 |
| `binding` | Binding site probability | 0-1 |
| `sequence_type` | wt or mut | categorical |

### 5.3 Local Changes TSV (`*.local.tsv`)

Changes in the ±5 residue window around each mutation:

| Column | Description | Units |
|--------|-------------|-------|
| `pkey` | Mutation identifier | string |
| `pos` | Position relative to mutation | residue index |
| `delta_rsa`, `delta_disorder` | Structural changes at this position | 0-1 |
| `is_mutation_site` | Whether this is the mutation position | boolean |

---

## 6. Structural Feature Interpretation

### 6.1 Surface Accessibility (RSA)

| RSA Range | Classification | Biological Relevance |
|-----------|---------------|---------------------|
| 0 - 0.25 | **Buried** | Core residues, hydrophobic interactions |
| 0.25 - 0.50 | **Intermediate** | Partially exposed, potential conformational flexibility |
| 0.50 - 1.0 | **Exposed** | Surface residues, interaction interfaces, epitopes |

**Delta RSA Interpretation:**
- **Δ > +0.2**: Buried -> Exposed transition (potential new interaction site, epitope exposure)
- **Δ < -0.2**: Exposed -> Buried transition (loss of interaction site, epitope masking)
- **\|Δ\| > 0.1**: Significant accessibility change

### 6.2 Secondary Structure (SS3)

| Code | Structure | Description |
|------|-----------|-------------|
| **H** | Helix | α-helix (regular H-bonding) |
| **E** | Strand | β-strand (extended conformation) |
| **C** | Coil | Loop/turn (irregular structure) |

**Important Transitions:**
- **H -> C or E -> C**: Loss of regular structure (potential destabilization)
- **C -> H or C -> E**: Gain of regular structure (potential stabilization)
- **H <-> E**: Major structural rearrangement

### 6.3 Disorder

| Disorder Score | Classification | Biological Context |
|---------------|---------------|-------------------|
| < 0.3 | **Ordered** | Structured, stable fold |
| 0.3 - 0.7 | **Intermediate** | Context-dependent folding |
| > 0.7 | **Disordered** | Intrinsically disordered region (IDR) |

**Clinical Relevance:**
- Disorder -> Order: May stabilize protein, affect binding
- Order -> Disorder: May destabilize, create flexible linkers

### 6.4 Binding Sites

| Binding Score | Interpretation |
|--------------|---------------|
| > 0.5 | Predicted binding site (protein-protein or protein-nucleic acid) |
| 0.3 - 0.5 | Potential binding region |
| < 0.3 | Unlikely to bind |

---

## 7. Change Classifications

### 7.1 Burial Classification

```
                    WT
           Buried  Intermediate  Exposed
Mutant
Buried       0        -1           -2
Intermediate +1        0           -1
Exposed      +2       +1            0
```

- **+2 (Buried -> Exposed)**: Potentially exposes epitopes, creates new interfaces
- **-2 (Exposed -> Buried)**: May mask epitopes, disrupt existing interactions
- **0 (No change)**: Minimal impact on surface properties

### 7.2 Disorder Classification

```
               WT
        Ordered  Intermediate  Disordered
Mutant
Ordered    0        -1            -2
Intermediate +1      0            -1
Disordered   +2     +1             0
```

- **+2 (Ordered -> Disordered)**: May increase flexibility, affect binding dynamics
- **-2 (Disordered -> Ordered)**: May rigidify structure, alter conformational ensemble

---

## 8. Command-Line Options

### Mode Selection
- `--mode {full-pipeline, netsurfp-only, parse-only}`: Processing mode (default: full-pipeline)

### Execution Backend
- `--native-netsurfp-path PATH`: Path to NetSurfP-3.0 predict.py script

### Processing Options
- `--mapping-dir DIR`: Mutation mapping CSV directory (required for full-pipeline)
- `--log FILE`: Validation log to skip failed mutations
- `--batch-size N`: Batch size for large FASTAs (default: 100)
- `--timeout SEC`: Command timeout (default: 600)

### Analysis Thresholds
- `--rsa-threshold FLOAT`: Minimum delta RSA for significant changes (default: 0.1)
- `--disorder-threshold FLOAT`: Minimum delta disorder for significant changes (default: 0.1)

### Cache and Output
- `--cache-dir DIR`: Custom cache directory
- `--no-cache`: Disable caching
- `--keep-intermediates`: Keep temp files for debugging
- `--verbose`: Enable verbose output

---

## 9. Troubleshooting

| Symptom | Resolution |
|---------|------------|
| `NetSurfP not found` | Install NetSurfP-3.0 and provide `--native-netsurfp-path` |
| `PyTorch/ESM not found` | Install PyTorch and download ESM model weights for native mode |
| Execution timeout | Increase `--timeout` (NetSurfP can be slow for long sequences) |
| `No mapping file found` | Verify `--mapping-dir` contains `{GENE}*.csv` files |
| `Out of memory` | Reduce `--batch-size` or use sequential processing for long proteins |
| Binary not found | Ensure Python 3.7+ with PyTorch installed, and provide `--native-netsurfp-path` |

---

## 10. Use Cases

### 10.1 Immunogenicity Assessment

Mutations can alter:
1. **Surface accessibility** -> Epitope exposure/masking
2. **Secondary structure** -> Conformational epitopes
3. **Disorder regions** -> Protease susceptibility

```bash
python netsurfp3-pipeline.py \
    wt_fastas/ \
    immunogenicity_analysis.tsv \
    --mode full-pipeline \
    --mapping-dir mappings/ \
    --rsa-threshold 0.15
```

### 10.2 Protein Stability Analysis

Identify mutations causing:
1. **Burial changes** -> Hydrophobic core disruption
2. **Disorder gain** -> Destabilization
3. **Secondary structure loss** -> Unfolding

```bash
python netsurfp3-pipeline.py \
    wt_fastas/ \
    stability_analysis.tsv \
    --mode full-pipeline \
    --mapping-dir mappings/ \
    --disorder-threshold 0.2
```

### 10.3 Interaction Interface Mapping

Detect changes in:
1. **Binding site predictions** -> Loss/gain of interaction capability
2. **Local structural context** -> Altered binding geometry
3. **Surface patches** -> Modified interaction interfaces

---

## 11. PSEUDOCODE Sections

### Implementation Status

**Completed:**
- Pipeline structure and CLI interface
- WT/mutant sequence synthesis
- Mapping CSV integration
- Validation log filtering
- Batch processing framework
- Structural comparison logic framework

**Needs Implementation:**
1. **Docker command structure** (`_run_docker_netsurfp`): Determine exact Docker image and command format
2. **NetSurfP output parsing** (`parse_netsurfp_output`): Implement based on actual output format (CSV/TSV/JSON)
3. **Native execution** (`_run_native_netsurfp`): Verify predict.py command-line arguments
4. **Caching system**: Implement hash-based caching similar to NetPhos
5. **Ensemble TSV generation**: Complete WT vs MUT comparison and output formatting
6. **Local window analysis**: Finalize ±5 residue context analysis
7. **Classification thresholds**: Tune RSA/disorder thresholds based on validation data

---

## 12. Citations

- NetSurfP-3.0: Høie, M. H. et al. (2022). "NetSurfP-3.0: accurate and fast prediction of protein structural features by protein language models and deep learning." *Nucleic Acids Research*, 50(W1), W510-W515.
- Klausen, M. S. et al. (2019). "NetSurfP-2.0: Improved prediction of protein structural features by integrated deep learning." *Proteins*, 87(6), 520-527.

---

## 13. Example Workflow

```bash
# 1. Prepare WT ORF FASTAs
ls ../../FASTA_files/newnt3/
# ABCB1_nt.fasta, BRCA1_nt.fasta, TP53_nt.fasta, ...

# 2. Ensure mapping CSVs exist
ls ../../mutations/combined/aa/
# ABCB1_transcript_mapping.csv, BRCA1_transcript_mapping.csv, ...

# 3. Run full pipeline
python netsurfp3-pipeline.py \
    ../../FASTA_files/newnt3/ \
    results/netsurfp_summary.tsv \
    --mode full-pipeline \
    --mapping-dir ../../mutations/combined/aa \
    --rsa-threshold 0.1 \
    --disorder-threshold 0.1 \
    --verbose \
    --keep-intermediates

# 4. Analyze outputs
# results/netsurfp_summary.tsv - Per-mutation structural summary
# results/netsurfp_summary.sites.tsv - Per-residue predictions
# results/netsurfp_summary.local.tsv - Local context changes

# 5. Filter for significant structural changes
# Look for:
# - delta_rsa > 0.2 (major burial changes)
# - delta_disorder > 0.2 (disorder transitions)
# - ss3_change != '=' (secondary structure changes)
```

---

## 14. Integration with Other Pipelines

NetSurfP-3.0 predictions complement other BioFeatureFactory analyses:

| Pipeline | NetSurfP Synergy |
|----------|-----------------|
| **NetMHC** | RSA > 0.5 + predicted epitope = accessible epitope |
| **NetNglyc** | Surface glycosylation sites (RSA > 0.4) are functionally relevant |
| **NetPhos** | Exposed phosphorylation sites (RSA > 0.3) are kinase-accessible |
| **SpliceAI** | Splice-altering mutations -> RSA changes -> functional impact |

---

**Note**: This pipeline is designed to integrate seamlessly with the existing BioFeatureFactory ecosystem and follows the same patterns as NetNglyc, NetPhos, and NetMHC pipelines.

---

## License

This pipeline wrapper is licensed under the AGPL-3.0 License - see the [LICENSE](../LICENSE) file in the root BioFeatureFactory directory for details.

The NetSurfP-3.0 library (`nsp3/`) is third-party software with its own license.
