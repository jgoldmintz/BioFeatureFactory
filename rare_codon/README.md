# Rare Codon Enrichment Pipeline

## Overview

This pipeline detects regions enriched or depleted in rare codons using sliding window analysis across a codon-aware multiple sequence alignment. It wraps the `cg_cotrans` library (Copyright William M. Jacobs, GPL v3).

---

## Requirements

| Component | Notes |
|-----------|-------|
| **cg_cotrans library** | Download from Shakhnovich Lab (see setup below) |
| Python ≥3.8 | With numpy, scipy |
| Codon-aware MSA | Generated by `../utils/msa/codon-msa-pipeline.py` |

### cg_cotrans Library Setup

```bash
cd rare_codon/
curl -O https://shakhnovich.faculty.chemistry.harvard.edu/files/shakhnovich/files/cg_cotrans.tar.gz
tar -xzf cg_cotrans.tar.gz
rm cg_cotrans.tar.gz
```

The pipeline imports directly from the `cg_cotrans/` subdirectory.

**Citation:** Jacobs WM, Shakhnovich EI. "Evidence of evolutionary selection for cotranslational folding." *PNAS* 114:11434–11439 (2017).

---

## Biological Background

### Rare Codons and Translation

Rare codons (low-frequency synonymous codons) cause ribosome pausing due to limited cognate tRNA availability. This pausing can be:

**Functional**:
- Enable co-translational protein folding
- Define translation speed boundaries
- Coordinate with mRNA structure

**Pathogenic**:
- Cause ribosome collisions
- Trigger mRNA decay
- Produce misfolded proteins

### Evolutionary Conservation of Rare Codon Clusters

Regions consistently enriched in rare codons across species are under **selective pressure** to maintain slow translation.

---

## Workflow

1. **Load Codon MSA**
   Read codon-aware multiple sequence alignment (FASTA format, triplet codons).

2. **Filter Sequences**
   Remove sequences with excessive gaps or low identity to focus sequence.

3. **Define Rare Codons**
   Identify rare codons based on threshold (default: frequency < 0.1).

4. **Sliding Window Analysis**
   For each position, count rare codons in surrounding window.

5. **Statistical Testing**
   Compare observed rare codon count to null model expectation.

6. **Map Mutations**
   Associate mutation positions with enrichment/depletion p-values.

---

## Input Requirements

### Codon-Aware MSA (Required)
- FASTA format with codon triplets
- Gaps as `---` (three dashes)
- Generated by `msa/codon-msa-pipeline.py` or similar

```
>Human_BRCA1
ATGGATCTG---GTAACCAACTCT...
>Mouse_Brca1
ATGGATCTG---GTAACCAACTCT...
```

### Codon Usage File (Required)
- Pre-computed `.p.gz` file from `calc_codon_usage.py`
- Contains genome-wide codon frequencies

### ORF FASTA (Required)
- Focus sequence nucleotide FASTA
- For mutation position mapping

### Mutations CSV (Required)
- List of nucleotide mutations to analyze

---

## Output Format

### Main Output (`{gene}.rare_codon.tsv`)

| Column | Description | Range |
|--------|-------------|-------|
| `pkey` | Unique identifier (`GENE-mutation`) | string |
| `Gene` | Gene symbol | string |
| `codon_position` | Codon position in ORF (1-based) | integer |
| `p_enriched` | P-value for rare codon enrichment | 0-1 |
| `p_depleted` | P-value for rare codon depletion | 0-1 |
| `f_enriched_wt` | Fraction of window with rare codons (WT) | 0-1 |
| `frac_seq_enriched` | Fraction of MSA sequences showing enrichment | 0-1 |
| `frac_seq_depleted` | Fraction of MSA sequences showing depletion | 0-1 |
| `n_rare` | Count of rare codons in window | integer |
| `window_size` | Sliding window width (codons) | integer |
| `qc_flags` | Quality control flags | string |

---

## Usage

### Basic Usage
```bash
python rare-codon-pipeline.py \
    --msa /path/to/codon.msa.fasta \
    --usage /path/to/codon_usage.p.gz \
    --wt-gi "Human_BRCA1" \
    --fasta /path/to/BRCA1.fasta \
    --mutations /path/to/mutations.csv \
    --output BRCA1.rare_codon.tsv
```

### With Custom Parameters
```bash
python rare-codon-pipeline.py \
    --msa /path/to/codon.msa.fasta \
    --usage /path/to/codon_usage.p.gz \
    --wt-gi "Human_BRCA1" \
    --fasta /path/to/BRCA1.fasta \
    --mutations /path/to/mutations.csv \
    --window-size 21 \
    --rare-threshold 0.15 \
    --min-aa-iden 0.6 \
    --output results.tsv
```

---

## Parameters

| Parameter | Default | Description |
|-----------|---------|-------------|
| `--msa` | Required | Path to codon-aware MSA FASTA |
| `--usage` | Required | Path to codon usage `.p.gz` file |
| `--wt-gi` | Required | Focus/wildtype sequence identifier |
| `--fasta` | Required | ORF FASTA for mutation mapping |
| `--mutations` | Required | Mutations CSV file |
| `--window-size` | 15 | Sliding window width (codons) |
| `--rare-model` | `no_norm` | Rare codon definition (`no_norm`, `cmax_norm`) |
| `--rare-threshold` | 0.1 | Frequency threshold for "rare" |
| `--null-model` | `genome` | Null model (`genome`, `eq`, `groups`) |
| `--max-len-diff` | 0.2 | Max length difference vs WT |
| `--min-aa-iden` | 0.5 | Min amino acid identity vs WT |

---

## Statistical Framework

### Rare Codon Definition

A codon is "rare" if its relative usage frequency is below threshold:

```
rare = 1  if f_codon < τ
       0  otherwise
```

Default threshold: $\tau = 0.1$ (bottom 10% of synonymous codons)

### Enrichment Test

For each position, count rare codons in window of size $L$:

$n_{rare} = \sum_{i=pos-L/2}^{pos+L/2} 1[codon_i \in rare]$

Compare to null expectation under genome-wide codon usage:

$p_{enriched} = P(N_{rare} \geq n_{rare} | H_0)$

### MSA Integration

Enrichment is computed across all sequences in the MSA:
- `frac_seq_enriched`: Fraction of sequences showing enrichment at position
- Consensus enrichment: Positions where multiple species show enrichment

---

## Interpretation

### Enrichment P-values

| p_enriched | p_depleted | Interpretation |
|------------|------------|----------------|
| < 0.05 | > 0.05 | **Enriched** in rare codons (slow translation) |
| > 0.05 | < 0.05 | **Depleted** in rare codons (fast translation) |
| > 0.05 | > 0.05 | No significant signal |
| < 0.05 | < 0.05 | Unusual (check data quality) |

### Biological Significance

**Enriched regions** (p_enriched < 0.05):
- Often at domain boundaries
- Before/after signal sequences
- Co-translational folding checkpoints

**Depleted regions** (p_depleted < 0.05):
- High translation efficiency needed
- Minimal pausing desired

---

## QC Flags

| Flag | Meaning | Action |
|------|---------|--------|
| `PASS` | Analysis successful | Use for analysis |
| `POSITION_NOT_IN_WINDOW` | Position near sequence edge | Expected at termini |
| `INVALID_MUTATION` | Could not parse mutation | Check input format |

---

## Pre-requisites

### Generate Codon Usage File

```bash
# Using cg_cotrans library
python calc_codon_usage.py \
    --input /path/to/transcriptome.fasta \
    --output codon_usage.p.gz
```

### Generate Codon MSA

```bash
# Using BFF codon MSA pipeline
python msa/codon-msa-pipeline.py \
    --protein-msa protein.msa.fasta \
    --nucleotide-dir nt_sequences/ \
    --output codon.msa.fasta
```

---

## Algorithm Details

### Window Centering

The window is centered on each codon position:
- Window size 15 -> positions -7 to +7 around center
- Edge positions have truncated windows (flagged)

### Sequence Filtering

Before analysis, sequences are filtered by:
1. **Length similarity**: Within 20% of focus sequence length
2. **Sequence identity**: ≥50% amino acid identity to focus
3. **Gap content**: Excessive gaps removed

### Null Models

| Model | Description |
|-------|-------------|
| `genome` | Genome-wide codon frequencies |
| `eq` | Equal probability for synonymous codons |
| `groups` | Codon groups (2-fold, 4-fold degeneracy) |

---

## Limitations

1. **MSA quality dependent**: Requires good quality codon-aware MSA
2. **Window edge effects**: Positions near termini have reduced power
3. **Species composition**: Results depend on MSA species diversity
4. **Single gene focus**: Analyzes one gene at a time

---

## References

- Pechmann S, Frydman J (2013) Evolutionary conservation of codon optimality reveals hidden signatures of cotranslational folding. **Nat Struct Mol Biol**, 20:237-243.
- Jacobs WM, Shakhnovich EI (2017) Evidence of evolutionary selection for cotranslational folding. **PNAS**, 114:11434-11439.
- Chaney JL, Clark PL (2015) Roles for synonymous codon usage in protein biogenesis. **Annu Rev Biophys**, 44:143-166.
- Zhou M, et al. (2013) Non-optimal codon usage affects expression, structure and function of clock protein FRQ. **Nature**, 495:111-115.

---

## Copyright Notice

The `cg_cotrans` library is Copyright (C) 2017 William M. Jacobs and is licensed under GPL v3. This pipeline wraps but does not modify the original library code.

---

## License

This wrapper pipeline is licensed under the AGPL-3.0 License - see the [LICENSE](../../LICENSE) file in the root BioFeatureFactory directory for details.

The underlying `cg_cotrans` library remains under GPL v3.
