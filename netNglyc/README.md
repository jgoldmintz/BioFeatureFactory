# NetNGlyc Ensemble Pipeline

Ensemble workflow for licensed NetNGlyc 1.0 with host-side SignalP 6.0.

---

## 1. Requirements

| Component            | Notes                                                                                                            |
|----------------------|------------------------------------------------------------------------------------------------------------------|
| NetNGlyc 1.0         | Either build the Docker image (`docker/build-container.sh`) or supply a native binary (`--native-netnglyc-bin`). |
| SignalP 6.0          | Must be on `PATH`. Cache defaults to `~/.signalp6_cache`, but `--cache-dir` relocates it.                        |
| Python ≥3.9          | Uses the shared utilities under `../dependencies`.                                                               |
| Mapping CSVs         | Per-gene NT→AA mappings (`mutant`, `aamutant`). Generated by exon-aware pipeline.                                |
| WT FASTAs            | ORF FASTAs (header `>ORF`) located under a directory or provided as a single file.                               |
| Log files (optional) | Validation logs consumed by `should_skip_mutation` to filter known failures.                                     |

---

## 2. Running

### Full pipeline (WT input → TSV ensemble)

```bash
python netnglyc-pipeline.py \
    ../../FASTA_files/newnt3/ \
    results/netnglyc_summary.tsv \
    --mode full-pipeline \
    --mapping-dir ../../mutations/combined/aa \
    --log /path/to/validation.log \
    --cache-dir /path/to/cache \
    --keep-intermediates
```

This flow:
1. Loads the ORF nucleotide FASTAs (header `ORF`) and synthesizes WT amino-acid FASTAs automatically.
2. Generates mutant amino-acid FASTAs per mapping CSV.
3. Runs SignalP 6.0 once per FASTA and executes NetNGlyc (Docker or native).
4. Writes the ensemble TSV trio (`summary`, `.events.tsv`, `.sites.tsv`).

### NetNGlyc-only processing

```bash
python netnglyc-pipeline.py wt/ABCB1.fasta raw_outputs/ --mode process
```

Produces raw `.out` files (no parsing).

### Parse-only mode

```bash
python netnglyc-pipeline.py \
    /var/folders/.../netnglyc_outputs_XXXX \
    ABCB1-summary.tsv \
    --mode parse \
    --mapping-dir ../../mutations/combined/aa \
    --cache-dir .
```

**Important:** `--mode parse` expects a directory that already contains NetNGlyc outputs (e.g., the `netnglyc_outputs_*` folder from a previous run). The parser reuses SignalP metadata from `--cache-dir` (or the default `~/.signalp6_cache`) by reading every `*_sp6_output/prediction_results.txt`.

---

## 3. Output Files

| File | Purpose |
|------|---------|
| `*.tsv` | Per-mutation summary (WT vs MUT deltas, SignalP context, QC flags). |
| `*.events.tsv` | Per-position NetNGlyc deltas classified as gained/lost/strengthened/etc. |
| `*.sites.tsv` | Raw WT and MUT predictions, including numeric encodings for motifs, jury agreement, and SignalP. |

### 3.1 Summary Columns

| Column                                                                               | Description                                                                                  | Units             |
|--------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------|-------------------|
| `pkey`                                                                               | `{GENE}-{MUTATION}` primary key sourced from mapping CSV.                                    | string            |
| `n_sites_wt`, `n_sites_mut`                                                          | Count of WT/MUT sites with potential ≥ `--threshold`.                                        | count             |
| `count_gained`, `count_lost`, `count_strengthened`, `count_weakened`, `count_stable` | Classification tallies for each mutation.                                                    | count             |
| `max_abs_delta`, `sum_abs_delta`                                                     | Maximum change in potential and sum of absolute changes.                                     | probability (0–1) |
| `top_event_type`                                                                     | Text label of dominant event.                                                                | categorical       |
| `top_event_classification_code`                                                      | Numeric encoding of dominant event (`gained=2`, `lost=-2`, etc.).                            | integer           |
| `top_event_delta`                                                                    | Δpotential for the dominant event.                                                           | probability (0–1) |
| `top_event_position`                                                                 | Amino-acid index of dominant event.                                                          | residue index     |
| `wt_signalp_has_signal`, `mut_signalp_has_signal`                                    | 1 if SignalP predicts a signal peptide, else 0.                                              | boolean (0/1)     |
| `wt_signalp_probability`, `mut_signalp_probability`                                  | SignalP cleavage probability.                                                                | probability (0–1) |
| `wt_signalp_cleavage`, `mut_signalp_cleavage`                                        | SignalP cleavage site when available.                                                        | residue index     |
| `frac_effect_post_cleavage`                                                          | Fraction of total $\left\lvert \Delta \right\rvert$ downstream of SignalP cleavage (see §4). | fraction (0–1)    |
| `qc_flags`                                                                           | Comma-separated diagnostics (`missing_wt`, `missing_mut`, `no_delta`, `no_signalp`).         | string            |

### 3.2 Events Columns

Per mutation/per motif position.

| Column                                                       | Description                                                                                               | Units             |
|--------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------|-------------------|
| `classification`                                             | `gained`, `lost`, `strengthened`, `weakened`, `stable`, `subthreshold`.                                   | categorical       |
| `classification_code`                                        | Numeric encoding (`gained=2`, `lost=-2`, `strengthened=1`, `weakened=-1`, `stable=0`, `subthreshold=-1`). | integer           |
| `wt_potential`, `mut_potential`, `delta`                     | WT score, MUT score, and $\Delta$.                                                                        | probability (0–1) |
| `wt_sequon`, `mut_sequon`                                    | Motif strings (e.g., `NKSE`).                                                                             | string            |
| `wt_above_threshold`, `mut_above_threshold`, `post_cleavage` | 1/0 booleans.                                                                                             | boolean (0/1)     |
| `position`                                                   | Amino-acid index for the motif.                                                                           | residue index     |

### 3.3 Sites Columns

| Column                                                          | Description                                               | Units                                 |
|-----------------------------------------------------------------|-----------------------------------------------------------|---------------------------------------|
| `jury_agreement`                                                | Raw NetNGlyc `(votes/total)` string.                      | string                                |
| `jury_agreement_score`                                          | Parsed float $\frac{\text{votes}}{\text{total}}$.         | fraction (0–1)                        |
| `n_glyc_result`, `n_glyc_result_code`                           | NetNGlyc symbol and numeric code (`+++ = 3 … --- = -3`).  | categorical / integer                 |
| `signalp_has_signal`, `signalp_probability`, `signalp_cleavage` | SignalP prediction (1/0), probability, and cleavage site. | boolean / probability / residue index |
| `above_threshold`                                               | Whether potential ≥ `--threshold`.                        | boolean (0/1)                         |

---

## 4. Statistical Notes

Let $s_{\text{wt},i}$ and $s_{\text{mut},i}$ be NetNGlyc potentials for motif $i$. The pipeline reports:

---

**Absolute delta:** 

$\lvert \Delta_i \rvert = \lvert s_{\text{mut},i} - s_{\text{wt},i} \rvert$.

---

**Max/Sum deltas:** 

$\max_i \lvert \Delta_i \rvert$, $\sum_i \lvert \Delta_i \rvert$ 
provide effect sizes comparable across genes (Borenstein et al., 2009).
 

---

**Post-cleavage fraction:** 

$\Phi = \dfrac{\sum_{i: p_i \ge c} \lvert \Delta_i \rvert}{\sum_i \lvert \Delta_i \rvert}$, where $p_i$ is the residue index and $c$ is the SignalP cleavage site. Glycosylation relevance depends on luminal exposure, so this serves as a localization score (Tobler, 1970; Cressie, 1993).

---

**Jury score:**

  `jury_agreement_score` $= \frac{\text{votes}}{\text{total}}$ parsed from `(votes/total)`, enabling numeric feature engineering.

Classifications align with NetNGlyc visibility thresholds: a site is **gained** if it crosses the potential cutoff only in the mutant, **lost** if the reverse, and **strengthened/weakened** when both are above the cutoff but $\lvert \Delta_i \rvert$ exceeds 0.05.

---

## 5. Troubleshooting

| Symptom                                             | Resolution                                                                                                                                              |
|-----------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------|
| `ProcessPoolExecutor ... SC_SEM_NSEMS_MAX` on macOS | Set `--processing-mode single` or run in Linux/native mode (macOS limits POSIX semaphores).                                                             |
| Parser says WT/MUT missing despite completed run    | Ensure `netnglyc_outputs_*` (with `wt/` and `mut/` directories) is passed to `--mode parse`; FASTA inputs are not valid parse targets.                  |
| SignalP columns blank in parse mode                 | Confirm `--cache-dir` matches the location containing `*_sp6_output/prediction_results.txt`, or omit `--cache-dir` to fall back to `~/.signalp6_cache`. |
| Repeated mutants flagged `missing_mut`              | No predictions were emitted (NetNGlyc wrote “No sites predicted”). Lower `--threshold` if you expect weaker signals.                                    |
| Docker not installed                                | Provide `--native-netnglyc-bin` and optional `--native-signalp-bin` (Linux) to run without Docker.                                                      |

---

## 6. Citations

- Borenstein, M., Hedges, L. V., Higgins, J. P. T., & Rothstein, H. R. (2009). *Introduction to Meta-Analysis*. Wiley.  
- Cressie, N. (1993). *Statistics for Spatial Data*. Wiley.  
- Tobler, W. R. (1970). “A Computer Movie Simulating Urban Growth in the Detroit Region.” *Economic Geography*, 46, 234–240.  
- SignalP 6.0: Almagro Armenteros, J. J. et al. (2022). “SignalP 6.0 predicts all five types of signal peptides using protein language models.” *Nature Biotechnology*, 40, 1023–1025.
